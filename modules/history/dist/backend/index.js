"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("bluebird-global");

const onServerStarted = async bp => {
  bp.database.createTableIfNotExists('msg_history', table => {
    table.increments('id').primary();
    table.string('msg_content');
  });
};

const onServerReady = async bp => {
  const router = bp.http.createRouterForBot('history');
  router.get('/conversations', async (req, res) => {
    const conversations = await bp.database.select('*').table('msg_history').map(x => JSON.parse(x.msg_content)).filter(msg => msg.botId === req.params.botId).map(msg => msg.threadId);
    const uniqueConversations = conversations.filter((value, index) => {
      return conversations.indexOf(value) === index;
    });
    res.send(uniqueConversations);
  });
  router.get('/messages/:convId', async (req, res) => {
    const convId = req.params.convId;
    const messages = await bp.database.select('*').table('msg_history').map(x => JSON.parse(x.msg_content)).filter(msg => msg.threadId === convId);
    res.send(messages);
  });
};

const onBotMount = async bp => {};

const onBotUnmount = async bp => {};

const onModuleUnmount = async bp => {};

const entryPoint = {
  onServerReady,
  onServerStarted,
  onBotMount,
  onBotUnmount,
  onModuleUnmount,
  definition: {
    name: 'history',
    fullName: 'History',
    homepage: 'https://botpress.io',
    menuIcon: 'timeline'
  }
};
var _default = entryPoint;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbIm9uU2VydmVyU3RhcnRlZCIsImJwIiwiZGF0YWJhc2UiLCJjcmVhdGVUYWJsZUlmTm90RXhpc3RzIiwidGFibGUiLCJpbmNyZW1lbnRzIiwicHJpbWFyeSIsInN0cmluZyIsIm9uU2VydmVyUmVhZHkiLCJyb3V0ZXIiLCJodHRwIiwiY3JlYXRlUm91dGVyRm9yQm90IiwiZ2V0IiwicmVxIiwicmVzIiwiY29udmVyc2F0aW9ucyIsInNlbGVjdCIsIm1hcCIsIngiLCJKU09OIiwicGFyc2UiLCJtc2dfY29udGVudCIsImZpbHRlciIsIm1zZyIsImJvdElkIiwicGFyYW1zIiwidGhyZWFkSWQiLCJ1bmlxdWVDb252ZXJzYXRpb25zIiwidmFsdWUiLCJpbmRleCIsImluZGV4T2YiLCJzZW5kIiwiY29udklkIiwibWVzc2FnZXMiLCJvbkJvdE1vdW50Iiwib25Cb3RVbm1vdW50Iiwib25Nb2R1bGVVbm1vdW50IiwiZW50cnlQb2ludCIsImRlZmluaXRpb24iLCJuYW1lIiwiZnVsbE5hbWUiLCJob21lcGFnZSIsIm1lbnVJY29uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBR0EsTUFBTUEsZUFBZSxHQUFHLE1BQU9DLEVBQVAsSUFBMEI7QUFDaERBLEVBQUFBLEVBQUUsQ0FBQ0MsUUFBSCxDQUFZQyxzQkFBWixDQUFtQyxhQUFuQyxFQUFrREMsS0FBSyxJQUFJO0FBQ3pEQSxJQUFBQSxLQUFLLENBQUNDLFVBQU4sQ0FBaUIsSUFBakIsRUFBdUJDLE9BQXZCO0FBQ0FGLElBQUFBLEtBQUssQ0FBQ0csTUFBTixDQUFhLGFBQWI7QUFDRCxHQUhEO0FBSUQsQ0FMRDs7QUFPQSxNQUFNQyxhQUFhLEdBQUcsTUFBT1AsRUFBUCxJQUEwQjtBQUM5QyxRQUFNUSxNQUFNLEdBQUdSLEVBQUUsQ0FBQ1MsSUFBSCxDQUFRQyxrQkFBUixDQUEyQixTQUEzQixDQUFmO0FBRUFGLEVBQUFBLE1BQU0sQ0FBQ0csR0FBUCxDQUFXLGdCQUFYLEVBQTZCLE9BQU9DLEdBQVAsRUFBWUMsR0FBWixLQUFvQjtBQUMvQyxVQUFNQyxhQUFhLEdBQUcsTUFBTWQsRUFBRSxDQUFDQyxRQUFILENBQ3pCYyxNQUR5QixDQUNsQixHQURrQixFQUV6QlosS0FGeUIsQ0FFbkIsYUFGbUIsRUFHekJhLEdBSHlCLENBR3JCQyxDQUFDLElBQUlDLElBQUksQ0FBQ0MsS0FBTCxDQUFXRixDQUFDLENBQUNHLFdBQWIsQ0FIZ0IsRUFJekJDLE1BSnlCLENBSWxCQyxHQUFHLElBQUlBLEdBQUcsQ0FBQ0MsS0FBSixLQUFjWCxHQUFHLENBQUNZLE1BQUosQ0FBV0QsS0FKZCxFQUt6QlAsR0FMeUIsQ0FLckJNLEdBQUcsSUFBSUEsR0FBRyxDQUFDRyxRQUxVLENBQTVCO0FBT0EsVUFBTUMsbUJBQW1CLEdBQUdaLGFBQWEsQ0FBQ08sTUFBZCxDQUFxQixDQUFDTSxLQUFELEVBQVFDLEtBQVIsS0FBa0I7QUFDakUsYUFBT2QsYUFBYSxDQUFDZSxPQUFkLENBQXNCRixLQUF0QixNQUFpQ0MsS0FBeEM7QUFDRCxLQUYyQixDQUE1QjtBQUlBZixJQUFBQSxHQUFHLENBQUNpQixJQUFKLENBQVNKLG1CQUFUO0FBQ0QsR0FiRDtBQWVBbEIsRUFBQUEsTUFBTSxDQUFDRyxHQUFQLENBQVcsbUJBQVgsRUFBZ0MsT0FBT0MsR0FBUCxFQUFZQyxHQUFaLEtBQW9CO0FBQ2xELFVBQU1rQixNQUFNLEdBQUduQixHQUFHLENBQUNZLE1BQUosQ0FBV08sTUFBMUI7QUFFQSxVQUFNQyxRQUFRLEdBQUcsTUFBTWhDLEVBQUUsQ0FBQ0MsUUFBSCxDQUNwQmMsTUFEb0IsQ0FDYixHQURhLEVBRXBCWixLQUZvQixDQUVkLGFBRmMsRUFHcEJhLEdBSG9CLENBR2hCQyxDQUFDLElBQUlDLElBQUksQ0FBQ0MsS0FBTCxDQUFXRixDQUFDLENBQUNHLFdBQWIsQ0FIVyxFQUlwQkMsTUFKb0IsQ0FJYkMsR0FBRyxJQUFJQSxHQUFHLENBQUNHLFFBQUosS0FBaUJNLE1BSlgsQ0FBdkI7QUFNQWxCLElBQUFBLEdBQUcsQ0FBQ2lCLElBQUosQ0FBU0UsUUFBVDtBQUNELEdBVkQ7QUFXRCxDQTdCRDs7QUErQkEsTUFBTUMsVUFBVSxHQUFHLE1BQU9qQyxFQUFQLElBQTBCLENBQUUsQ0FBL0M7O0FBRUEsTUFBTWtDLFlBQVksR0FBRyxNQUFPbEMsRUFBUCxJQUEwQixDQUFFLENBQWpEOztBQUVBLE1BQU1tQyxlQUFlLEdBQUcsTUFBT25DLEVBQVAsSUFBMEIsQ0FBRSxDQUFwRDs7QUFFQSxNQUFNb0MsVUFBZ0MsR0FBRztBQUN2QzdCLEVBQUFBLGFBRHVDO0FBRXZDUixFQUFBQSxlQUZ1QztBQUd2Q2tDLEVBQUFBLFVBSHVDO0FBSXZDQyxFQUFBQSxZQUp1QztBQUt2Q0MsRUFBQUEsZUFMdUM7QUFNdkNFLEVBQUFBLFVBQVUsRUFBRTtBQUNWQyxJQUFBQSxJQUFJLEVBQUUsU0FESTtBQUVWQyxJQUFBQSxRQUFRLEVBQUUsU0FGQTtBQUdWQyxJQUFBQSxRQUFRLEVBQUUscUJBSEE7QUFJVkMsSUFBQUEsUUFBUSxFQUFFO0FBSkE7QUFOMkIsQ0FBekM7ZUFjZUwsVSIsInNvdXJjZVJvb3QiOiIvaG9tZS9mcmFuY29pcy9Eb2N1bWVudHMvYm90cHJlc3Mtcm9vdC9ib3RwcmVzcy9tb2R1bGVzL2hpc3Rvcnkvc3JjL2JhY2tlbmQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ2JsdWViaXJkLWdsb2JhbCdcbmltcG9ydCAqIGFzIHNkayBmcm9tICdib3RwcmVzcy9zZGsnXG5cbmNvbnN0IG9uU2VydmVyU3RhcnRlZCA9IGFzeW5jIChicDogdHlwZW9mIHNkaykgPT4ge1xuICBicC5kYXRhYmFzZS5jcmVhdGVUYWJsZUlmTm90RXhpc3RzKCdtc2dfaGlzdG9yeScsIHRhYmxlID0+IHtcbiAgICB0YWJsZS5pbmNyZW1lbnRzKCdpZCcpLnByaW1hcnkoKVxuICAgIHRhYmxlLnN0cmluZygnbXNnX2NvbnRlbnQnKVxuICB9KVxufVxuXG5jb25zdCBvblNlcnZlclJlYWR5ID0gYXN5bmMgKGJwOiB0eXBlb2Ygc2RrKSA9PiB7XG4gIGNvbnN0IHJvdXRlciA9IGJwLmh0dHAuY3JlYXRlUm91dGVyRm9yQm90KCdoaXN0b3J5JylcblxuICByb3V0ZXIuZ2V0KCcvY29udmVyc2F0aW9ucycsIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIGNvbnN0IGNvbnZlcnNhdGlvbnMgPSBhd2FpdCBicC5kYXRhYmFzZVxuICAgICAgLnNlbGVjdCgnKicpXG4gICAgICAudGFibGUoJ21zZ19oaXN0b3J5JylcbiAgICAgIC5tYXAoeCA9PiBKU09OLnBhcnNlKHgubXNnX2NvbnRlbnQpKVxuICAgICAgLmZpbHRlcihtc2cgPT4gbXNnLmJvdElkID09PSByZXEucGFyYW1zLmJvdElkKVxuICAgICAgLm1hcChtc2cgPT4gbXNnLnRocmVhZElkKVxuXG4gICAgY29uc3QgdW5pcXVlQ29udmVyc2F0aW9ucyA9IGNvbnZlcnNhdGlvbnMuZmlsdGVyKCh2YWx1ZSwgaW5kZXgpID0+IHtcbiAgICAgIHJldHVybiBjb252ZXJzYXRpb25zLmluZGV4T2YodmFsdWUpID09PSBpbmRleFxuICAgIH0pXG5cbiAgICByZXMuc2VuZCh1bmlxdWVDb252ZXJzYXRpb25zKVxuICB9KVxuXG4gIHJvdXRlci5nZXQoJy9tZXNzYWdlcy86Y29udklkJywgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgY29udklkID0gcmVxLnBhcmFtcy5jb252SWRcblxuICAgIGNvbnN0IG1lc3NhZ2VzID0gYXdhaXQgYnAuZGF0YWJhc2VcbiAgICAgIC5zZWxlY3QoJyonKVxuICAgICAgLnRhYmxlKCdtc2dfaGlzdG9yeScpXG4gICAgICAubWFwKHggPT4gSlNPTi5wYXJzZSh4Lm1zZ19jb250ZW50KSlcbiAgICAgIC5maWx0ZXIobXNnID0+IG1zZy50aHJlYWRJZCA9PT0gY29udklkKVxuXG4gICAgcmVzLnNlbmQobWVzc2FnZXMpXG4gIH0pXG59XG5cbmNvbnN0IG9uQm90TW91bnQgPSBhc3luYyAoYnA6IHR5cGVvZiBzZGspID0+IHt9XG5cbmNvbnN0IG9uQm90VW5tb3VudCA9IGFzeW5jIChicDogdHlwZW9mIHNkaykgPT4ge31cblxuY29uc3Qgb25Nb2R1bGVVbm1vdW50ID0gYXN5bmMgKGJwOiB0eXBlb2Ygc2RrKSA9PiB7fVxuXG5jb25zdCBlbnRyeVBvaW50OiBzZGsuTW9kdWxlRW50cnlQb2ludCA9IHtcbiAgb25TZXJ2ZXJSZWFkeSxcbiAgb25TZXJ2ZXJTdGFydGVkLFxuICBvbkJvdE1vdW50LFxuICBvbkJvdFVubW91bnQsXG4gIG9uTW9kdWxlVW5tb3VudCxcbiAgZGVmaW5pdGlvbjoge1xuICAgIG5hbWU6ICdoaXN0b3J5JyxcbiAgICBmdWxsTmFtZTogJ0hpc3RvcnknLFxuICAgIGhvbWVwYWdlOiAnaHR0cHM6Ly9ib3RwcmVzcy5pbycsXG4gICAgbWVudUljb246ICd0aW1lbGluZSdcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBlbnRyeVBvaW50XG4iXX0=