//CHECKSUM:04d9e7e47055a29be502165ba6d2d556a121701d75e31a212e475a67c8e30ea9
"use strict";

const base = require('./_base');

const Card = require('./card');

const url = require('url');

function render(data) {
  const events = [];

  if (data.typing) {
    events.push({
      type: 'typing',
      value: data.typing
    });
  }

  return [...events, {
    text: ' ',
    type: 'carousel',
    elements: data.items.map(card => ({
      title: card.title,
      picture: card.image ? url.resolve(data.BOT_URL, card.image) : null,
      subtitle: card.subtitle,
      buttons: (card.actions || []).map(a => {
        if (a.action === 'Say something') {
          return {
            title: a.title,
            payload: a.title
          };
        } else if (a.action === 'Open URL') {
          return {
            title: a.title,
            url: a.url.replace('BOT_URL', data.BOT_URL)
          };
        } else if (a.action === 'Postback') {
          return {
            title: a.title,
            payload: a.payload
          };
        } else {
          throw new Error(`Webchat carousel does not support "${a.action}" action-buttons at the moment`);
        }
      })
    }))
  }];
}

function renderMessenger(data) {
  const renderElements = data => {
    return data.items.map(card => ({
      title: card.title,
      image_url: card.image ? url.resolve(data.BOT_URL, card.image) : null,
      subtitle: card.subtitle,
      buttons: (card.actions || []).map(a => {
        if (a.action === 'Say something') {
          throw new Error('Channel-Messenger carousel does not support "Say something" action-buttons at the moment');
        } else if (a.action === 'Open URL') {
          return {
            type: 'web_url',
            url: a.url,
            title: a.title
          };
        } else {
          throw new Error(`Channel-Messenger carousel does not support "${a.action}" action-buttons at the moment`);
        }
      })
    }));
  };

  return [{
    type: 'typing',
    value: data.typing
  }, {
    attachment: {
      type: 'template',
      payload: {
        template_type: 'generic',
        elements: renderElements(data)
      }
    }
  }];
}

function renderElement(data, channel) {
  if (channel === 'web' || channel === 'api' || channel === 'telegram') {
    return render(data);
  } else if (channel === 'messenger') {
    return renderMessenger(data);
  }

  return []; // TODO Handle channel not supported
}

module.exports = {
  id: 'builtin_carousel',
  group: 'Built-in Messages',
  title: 'Carousel',
  jsonSchema: {
    description: 'A carousel is an array of cards',
    type: 'object',
    required: ['items'],
    properties: {
      items: {
        type: 'array',
        title: 'Carousel Cards',
        items: Card.jsonSchema
      },
      ...base.typingIndicators
    }
  },
  computePreviewText: formData => `Carousel: (${formData.items.length}) ${formData.items[0].title}`,
  renderElement: renderElement
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhcm91c2VsLmpzIl0sIm5hbWVzIjpbImJhc2UiLCJyZXF1aXJlIiwiQ2FyZCIsInVybCIsInJlbmRlciIsImRhdGEiLCJldmVudHMiLCJ0eXBpbmciLCJwdXNoIiwidHlwZSIsInZhbHVlIiwidGV4dCIsImVsZW1lbnRzIiwiaXRlbXMiLCJtYXAiLCJjYXJkIiwidGl0bGUiLCJwaWN0dXJlIiwiaW1hZ2UiLCJyZXNvbHZlIiwiQk9UX1VSTCIsInN1YnRpdGxlIiwiYnV0dG9ucyIsImFjdGlvbnMiLCJhIiwiYWN0aW9uIiwicGF5bG9hZCIsInJlcGxhY2UiLCJFcnJvciIsInJlbmRlck1lc3NlbmdlciIsInJlbmRlckVsZW1lbnRzIiwiaW1hZ2VfdXJsIiwiYXR0YWNobWVudCIsInRlbXBsYXRlX3R5cGUiLCJyZW5kZXJFbGVtZW50IiwiY2hhbm5lbCIsIm1vZHVsZSIsImV4cG9ydHMiLCJpZCIsImdyb3VwIiwianNvblNjaGVtYSIsImRlc2NyaXB0aW9uIiwicmVxdWlyZWQiLCJwcm9wZXJ0aWVzIiwidHlwaW5nSW5kaWNhdG9ycyIsImNvbXB1dGVQcmV2aWV3VGV4dCIsImZvcm1EYXRhIiwibGVuZ3RoIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLFNBQUQsQ0FBcEI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsUUFBRCxDQUFwQjs7QUFDQSxNQUFNRSxHQUFHLEdBQUdGLE9BQU8sQ0FBQyxLQUFELENBQW5COztBQUVBLFNBQVNHLE1BQVQsQ0FBZ0JDLElBQWhCLEVBQXNCO0FBQ3BCLFFBQU1DLE1BQU0sR0FBRyxFQUFmOztBQUVBLE1BQUlELElBQUksQ0FBQ0UsTUFBVCxFQUFpQjtBQUNmRCxJQUFBQSxNQUFNLENBQUNFLElBQVAsQ0FBWTtBQUNWQyxNQUFBQSxJQUFJLEVBQUUsUUFESTtBQUVWQyxNQUFBQSxLQUFLLEVBQUVMLElBQUksQ0FBQ0U7QUFGRixLQUFaO0FBSUQ7O0FBRUQsU0FBTyxD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QUNMSixRQUFBQSxJQUFJLEVBQUUsT0FERDtBQUVMTyxRQUFBQSxLQUFLLEVBQUUsZ0JBRkY7QUFHTEgsUUFBQUEsS0FBSyxFQUFFWCxJQUFJLENBQUNzQztBQUhQLE9BREc7QUFNVixTQUFHeEMsSUFBSSxDQUFDNEM7QUFORTtBQUpGLEdBTEc7QUFrQmZDLEVBQUFBLGtCQUFrQixFQUFFQyxRQUFRLElBQUssY0FBYUEsUUFBUSxDQUFDakMsS0FBVCxDQUFla0MsTUFBTyxLQUFJRCxRQUFRLENBQUNqQyxLQUFULENBQWUsQ0FBZixFQUFrQkcsS0FBTSxFQWxCakY7QUFtQmZrQixFQUFBQSxhQUFhLEVBQUVBO0FBbkJBLENBQWpCIiwic291cmNlUm9vdCI6Ii9Wb2x1bWVzL2JwL2JvdHByZXNzL21vZHVsZXMvYnVpbHRpbi9zcmMvYmFja2VuZCIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGJhc2UgPSByZXF1aXJlKCcuL19iYXNlJylcbmNvbnN0IENhcmQgPSByZXF1aXJlKCcuL2NhcmQnKVxuY29uc3QgdXJsID0gcmVxdWlyZSgndXJsJylcblxuZnVuY3Rpb24gcmVuZGVyKGRhdGEpIHtcbiAgY29uc3QgZXZlbnRzID0gW11cblxuICBpZiAoZGF0YS50eXBpbmcpIHtcbiAgICBldmVudHMucHVzaCh7XG4gICAgICB0eXBlOiAndHlwaW5nJyxcbiAgICAgIHZhbHVlOiBkYXRhLnR5cGluZ1xuICAgIH0pXG4gIH1cblxuICByZXR1cm4gW1xuICAgIC4uLmV2ZW50cyxcbiAgICB7XG4gICAgICB0ZXh0OiAnICcsXG4gICAgICB0eXBlOiAnY2Fyb3VzZWwnLFxuICAgICAgZWxlbWVudHM6IGRhdGEuaXRlbXMubWFwKGNhcmQgPT4gKHtcbiAgICAgICAgdGl0bGU6IGNhcmQudGl0bGUsXG4gICAgICAgIHBpY3R1cmU6IGNhcmQuaW1hZ2UgPyB1cmwucmVzb2x2ZShkYXRhLkJPVF9VUkwsIGNhcmQuaW1hZ2UpIDogbnVsbCxcbiAgICAgICAgc3VidGl0bGU6IGNhcmQuc3VidGl0bGUsXG4gICAgICAgIGJ1dHRvbnM6IChjYXJkLmFjdGlvbnMgfHwgW10pLm1hcChhID0+IHtcbiAgICAgICAgICBpZiAoYS5hY3Rpb24gPT09ICdTYXkgc29tZXRoaW5nJykge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgdGl0bGU6IGEudGl0bGUsXG4gICAgICAgICAgICAgIHBheWxvYWQ6IGEudGl0bGVcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2UgaWYgKGEuYWN0aW9uID09PSAnT3BlbiBVUkwnKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICB0aXRsZTogYS50aXRsZSxcbiAgICAgICAgICAgICAgdXJsOiBhLnVybC5yZXBsYWNlKCdCT1RfVVJMJywgZGF0YS5CT1RfVVJMKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSBpZiAoYS5hY3Rpb24gPT09ICdQb3N0YmFjaycpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIHRpdGxlOiBhLnRpdGxlLFxuICAgICAgICAgICAgICBwYXlsb2FkOiBhLnBheWxvYWRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBXZWJjaGF0IGNhcm91c2VsIGRvZXMgbm90IHN1cHBvcnQgXCIke2EuYWN0aW9ufVwiIGFjdGlvbi1idXR0b25zIGF0IHRoZSBtb21lbnRgKVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH0pKVxuICAgIH1cbiAgXVxufVxuXG5mdW5jdGlvbiByZW5kZXJNZXNzZW5nZXIoZGF0YSkge1xuICBjb25zdCByZW5kZXJFbGVtZW50cyA9IGRhdGEgPT4ge1xuICAgIHJldHVybiBkYXRhLml0ZW1zLm1hcChjYXJkID0+ICh7XG4gICAgICB0aXRsZTogY2FyZC50aXRsZSxcbiAgICAgIGltYWdlX3VybDogY2FyZC5pbWFnZSA/IHVybC5yZXNvbHZlKGRhdGEuQk9UX1VSTCwgY2FyZC5pbWFnZSkgOiBudWxsLFxuICAgICAgc3VidGl0bGU6IGNhcmQuc3VidGl0bGUsXG4gICAgICBidXR0b25zOiAoY2FyZC5hY3Rpb25zIHx8IFtdKS5tYXAoYSA9PiB7XG4gICAgICAgIGlmIChhLmFjdGlvbiA9PT0gJ1NheSBzb21ldGhpbmcnKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDaGFubmVsLU1lc3NlbmdlciBjYXJvdXNlbCBkb2VzIG5vdCBzdXBwb3J0IFwiU2F5IHNvbWV0aGluZ1wiIGFjdGlvbi1idXR0b25zIGF0IHRoZSBtb21lbnQnKVxuICAgICAgICB9IGVsc2UgaWYgKGEuYWN0aW9uID09PSAnT3BlbiBVUkwnKSB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR5cGU6ICd3ZWJfdXJsJyxcbiAgICAgICAgICAgIHVybDogYS51cmwsXG4gICAgICAgICAgICB0aXRsZTogYS50aXRsZVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENoYW5uZWwtTWVzc2VuZ2VyIGNhcm91c2VsIGRvZXMgbm90IHN1cHBvcnQgXCIke2EuYWN0aW9ufVwiIGFjdGlvbi1idXR0b25zIGF0IHRoZSBtb21lbnRgKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pKVxuICB9XG5cbiAgcmV0dXJuIFtcbiAgICB7XG4gICAgICB0eXBlOiAndHlwaW5nJyxcbiAgICAgIHZhbHVlOiBkYXRhLnR5cGluZ1xuICAgIH0sXG4gICAge1xuICAgICAgYXR0YWNobWVudDoge1xuICAgICAgICB0eXBlOiAndGVtcGxhdGUnLFxuICAgICAgICBwYXlsb2FkOiB7XG4gICAgICAgICAgdGVtcGxhdGVfdHlwZTogJ2dlbmVyaWMnLFxuICAgICAgICAgIGVsZW1lbnRzOiByZW5kZXJFbGVtZW50cyhkYXRhKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICBdXG59XG5cbmZ1bmN0aW9uIHJlbmRlckVsZW1lbnQoZGF0YSwgY2hhbm5lbCkge1xuICBpZiAoY2hhbm5lbCA9PT0gJ3dlYicgfHwgY2hhbm5lbCA9PT0gJ2FwaScgfHwgY2hhbm5lbCA9PT0gJ3RlbGVncmFtJykge1xuICAgIHJldHVybiByZW5kZXIoZGF0YSlcbiAgfSBlbHNlIGlmIChjaGFubmVsID09PSAnbWVzc2VuZ2VyJykge1xuICAgIHJldHVybiByZW5kZXJNZXNzZW5nZXIoZGF0YSlcbiAgfVxuXG4gIHJldHVybiBbXSAvLyBUT0RPIEhhbmRsZSBjaGFubmVsIG5vdCBzdXBwb3J0ZWRcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGlkOiAnYnVpbHRpbl9jYXJvdXNlbCcsXG4gIGdyb3VwOiAnQnVpbHQtaW4gTWVzc2FnZXMnLFxuICB0aXRsZTogJ0Nhcm91c2VsJyxcblxuICBqc29uU2NoZW1hOiB7XG4gICAgZGVzY3JpcHRpb246ICdBIGNhcm91c2VsIGlzIGFuIGFycmF5IG9mIGNhcmRzJyxcbiAgICB0eXBlOiAnb2JqZWN0JyxcbiAgICByZXF1aXJlZDogWydpdGVtcyddLFxuICAgIHByb3BlcnRpZXM6IHtcbiAgICAgIGl0ZW1zOiB7XG4gICAgICAgIHR5cGU6ICdhcnJheScsXG4gICAgICAgIHRpdGxlOiAnQ2Fyb3VzZWwgQ2FyZHMnLFxuICAgICAgICBpdGVtczogQ2FyZC5qc29uU2NoZW1hXG4gICAgICB9LFxuICAgICAgLi4uYmFzZS50eXBpbmdJbmRpY2F0b3JzXG4gICAgfVxuICB9LFxuICBjb21wdXRlUHJldmlld1RleHQ6IGZvcm1EYXRhID0+IGBDYXJvdXNlbDogKCR7Zm9ybURhdGEuaXRlbXMubGVuZ3RofSkgJHtmb3JtRGF0YS5pdGVtc1swXS50aXRsZX1gLFxuICByZW5kZXJFbGVtZW50OiByZW5kZXJFbGVtZW50XG59XG4iXX0=